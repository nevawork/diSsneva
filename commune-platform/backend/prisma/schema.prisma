// ============================================================
// PRISMA SCHEMA - Commune Platform
// ============================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// USER MODELS
// ============================================================

model users {
  id                      BigInt           @id @default(autoincrement())
  snowflakeId             BigInt           @unique @map("snowflake_id")
  email                   String           @unique @db.VarChar(255)
  username                String           @db.VarChar(32)
  displayName             String?          @map("display_name") @db.VarChar(32)
  passwordHash            String           @map("password_hash")
  avatarUrl               String?          @map("avatar_url") @db.VarChar(500)
  bannerUrl               String?          @map("banner_url") @db.VarChar(500)
  bio                     String?
  locale                  String           @default("en-US") @db.VarChar(10)
  timezone                String           @default("UTC") @db.VarChar(50)
  emailVerified           Boolean          @default(false) @map("email_verified")
  twoFactorEnabled        Boolean          @default(false) @map("two_factor_enabled")
  twoFactorSecret         String?          @map("two_factor_secret")
  backupCodes             String[]         @map("backup_codes")
  status                  String           @default("offline") @db.VarChar(20)
  customStatus            String?          @map("custom_status") @db.VarChar(128)
  statusExpiresAt         DateTime?        @map("status_expires_at")
  lastSeenAt              DateTime         @default(now()) @map("last_seen_at")
  createdAt               DateTime         @default(now()) @map("created_at")
  updatedAt               DateTime         @default(now()) @map("updated_at")
  deletedAt               DateTime?        @map("deleted_at")
  isDeleted               Boolean          @default(false) @map("is_deleted")
  subscriptionTier        String           @default("free") @map("subscription_tier") @db.VarChar(20)
  subscriptionExpiresAt   DateTime?        @map("subscription_expires_at")
  uploadQuotaBytes        BigInt           @default(104857600) @map("upload_quota_bytes")
  uploadUsedBytes         BigInt           @default(0) @map("upload_used_bytes")
  metadata                Json             @default("{}")

  // Relations
  sessions                userSessions[]
  ownedServers            servers[]        @relation("ServerOwner")
  serverMemberships       serverMembers[]
  messages                messages[]
  reactions               reactions[]
  voiceSessions           voiceSessions[]
  notifications           notifications[]
  subscriptions           subscriptions[]
  createdEmojis           emojis[]         @relation("EmojiCreator")
  friendships             friendships[]    @relation("FriendshipUser")
  friendOf                friendships[]    @relation("FriendshipFriend")
  auditLogs               auditLogs[]
  analyticsEvents         analyticsEvents[]

  @@index([email])
  @@index([username])
  @@index([snowflakeId])
  @@index([status])
  @@index([subscriptionTier, subscriptionExpiresAt])
  @@map("users")
}

model userSessions {
  id                String    @id @default(uuid()) @db.Uuid
  userId            BigInt    @map("user_id")
  refreshTokenHash  String    @map("refresh_token_hash")
  deviceFingerprint String?   @map("device_fingerprint") @db.VarChar(255)
  deviceName        String?   @map("device_name") @db.VarChar(255)
  deviceType        String?   @map("device_type") @db.VarChar(50)
  os                String?   @db.VarChar(100)
  browser           String?   @db.VarChar(100)
  ipAddress         String?   @map("ip_address") @db.VarChar(45)
  location          String?   @db.VarChar(255)
  isTrusted         Boolean   @default(false) @map("is_trusted")
  lastActiveAt      DateTime  @default(now()) @map("last_active_at")
  expiresAt         DateTime  @map("expires_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  revokedAt         DateTime? @map("revoked_at")
  revokedReason     String?   @map("revoked_reason") @db.VarChar(100)

  // Relations
  user users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshTokenHash])
  @@index([expiresAt])
  @@map("user_sessions")
}

// ============================================================
// SERVER MODELS
// ============================================================

model servers {
  id                          BigInt          @id @default(autoincrement())
  snowflakeId                 BigInt          @unique @map("snowflake_id")
  name                        String          @db.VarChar(100)
  description                 String?
  iconUrl                     String?         @map("icon_url") @db.VarChar(500)
  bannerUrl                   String?         @map("banner_url") @db.VarChar(500)
  ownerId                     BigInt          @map("owner_id")
  defaultChannelId            BigInt?         @map("default_channel_id")
  systemChannelId             BigInt?         @map("system_channel_id")
  rulesChannelId              BigInt?         @map("rules_channel_id")
  publicUpdatesChannelId      BigInt?         @map("public_updates_channel_id")
  afkChannelId                BigInt?         @map("afk_channel_id")
  afkTimeout                  Int             @default(300) @map("afk_timeout")
  verificationLevel           Int             @default(0) @map("verification_level")
  defaultMessageNotifications Int             @default(0) @map("default_message_notifications")
  explicitContentFilter       Int             @default(0) @map("explicit_content_filter")
  vanityUrlCode               String?         @map("vanity_url_code") @db.VarChar(20)
  preferredLocale             String          @default("en-US") @map("preferred_locale") @db.VarChar(10)
  nsfwLevel                   Int             @default(0) @map("nsfw_level")
  premiumTier                 Int             @default(0) @map("premium_tier")
  premiumSubscriptionCount    Int             @default(0) @map("premium_subscription_count")
  maxMembers                  Int             @default(250000) @map("max_members")
  maxPresences                Int             @default(25000) @map("max_presences")
  maxVideoChannelUsers        Int             @default(25) @map("max_video_channel_users")
  approximateMemberCount      Int             @default(0) @map("approximate_member_count")
  approximatePresenceCount    Int             @default(0) @map("approximate_presence_count")
  widgetEnabled               Boolean         @default(false) @map("widget_enabled")
  widgetChannelId             BigInt?         @map("widget_channel_id")
  isPublic                    Boolean         @default(false) @map("is_public")
  isDiscoverable              Boolean         @default(false) @map("is_discoverable")
  createdAt                   DateTime        @default(now()) @map("created_at")
  updatedAt                   DateTime        @default(now()) @map("updated_at")
  deletedAt                   DateTime?       @map("deleted_at")
  isDeleted                   Boolean         @default(false) @map("is_deleted")
  metadata                    Json            @default("{}")

  // Relations
  owner           users           @relation("ServerOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members         serverMembers[]
  roles           roles[]
  channels        channels[]
  emojis          emojis[]
  invites         invites[]
  webhooks        webhooks[]
  boosts          serverBoosts[]
  auditLogs       auditLogs[]
  subscriptions   subscriptions[]
  bans            bans[]

  @@index([ownerId])
  @@index([snowflakeId])
  @@index([isPublic, isDiscoverable])
  @@map("servers")
}

model serverMembers {
  id                        BigInt       @id @default(autoincrement())
  serverId                  BigInt       @map("server_id")
  userId                    BigInt       @map("user_id")
  nickname                  String?      @db.VarChar(32)
  avatarUrl                 String?      @map("avatar_url") @db.VarChar(500)
  joinedAt                  DateTime     @default(now()) @map("joined_at")
  premiumSince              DateTime?    @map("premium_since")
  isDeafened                Boolean      @default(false) @map("is_deafened")
  isMuted                   Boolean      @default(false) @map("is_muted")
  pending                   Boolean      @default(false)
  communicationDisabledUntil DateTime?   @map("communication_disabled_until")
  flags                     Int          @default(0)

  // Relations
  server      servers       @relation(fields: [serverId], references: [id], onDelete: Cascade)
  user        users         @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleMembers roleMembers[]

  @@unique([serverId, userId])
  @@index([serverId])
  @@index([userId])
  @@index([joinedAt])
  @@map("server_members")
}

model roles {
  id              BigInt          @id @default(autoincrement())
  snowflakeId     BigInt          @unique @map("snowflake_id")
  serverId        BigInt          @map("server_id")
  name            String          @db.VarChar(100)
  color           Int             @default(0)
  hoist           Boolean         @default(false)
  iconUrl         String?         @map("icon_url") @db.VarChar(500)
  unicodeEmoji    String?         @map("unicode_emoji") @db.VarChar(100)
  position        Int             @default(0)
  permissions     BigInt          @default(0)
  isMentionable   Boolean         @default(false) @map("is_mentionable")
  isDefault       Boolean         @default(false) @map("is_default")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @default(now()) @map("updated_at")
  tags            Json            @default("{}")

  // Relations
  server      servers         @relation(fields: [serverId], references: [id], onDelete: Cascade)
  roleMembers roleMembers[]

  @@index([serverId])
  @@index([serverId, position])
  @@map("roles")
}

model roleMembers {
  roleId          BigInt        @map("role_id")
  serverMemberId  BigInt        @map("server_member_id")
  assignedAt      DateTime      @default(now()) @map("assigned_at")
  assignedBy      BigInt?       @map("assigned_by")

  // Relations
  role         roles         @relation(fields: [roleId], references: [id], onDelete: Cascade)
  serverMember serverMembers @relation(fields: [serverMemberId], references: [id], onDelete: Cascade)

  @@id([roleId, serverMemberId])
  @@index([serverMemberId])
  @@map("role_members")
}

// ============================================================
// CHANNEL MODELS
// ============================================================

model channels {
  id                                  BigInt              @id @default(autoincrement())
  snowflakeId                         BigInt              @unique @map("snowflake_id")
  serverId                            BigInt?             @map("server_id")
  parentId                            BigInt?             @map("parent_id")
  creatorId                           BigInt?             @map("creator_id")
  name                                String              @db.VarChar(100)
  type                                Int
  topic                               String?
  iconUrl                             String?             @map("icon_url") @db.VarChar(500)
  position                            Int                 @default(0)
  permissionOverwrites                Json                @default("[]") @map("permission_overwrites")
  isNsfw                              Boolean             @default(false) @map("is_nsfw")
  rateLimitPerUser                    Int                 @default(0) @map("rate_limit_per_user")
  bitrate                             Int?
  userLimit                           Int?                @map("user_limit")
  rtcRegion                           String?             @map("rtc_region") @db.VarChar(100)
  videoQualityMode                    Int                 @default(1) @map("video_quality_mode")
  lastMessageId                       BigInt?             @map("last_message_id")
  lastPinTimestamp                    DateTime?           @map("last_pin_timestamp")
  defaultAutoArchiveDuration          Int                 @default(4320) @map("default_auto_archive_duration")
  defaultThreadRateLimitPerUser       Int                 @default(0) @map("default_thread_rate_limit_per_user")
  defaultSortOrder                    Int?                @map("default_sort_order")
  defaultForumLayout                  Int?                @map("default_forum_layout")
  availableTags                       Json                @default("[]") @map("available_tags")
  defaultReactionEmoji                Json?               @map("default_reaction_emoji")
  createdAt                           DateTime            @default(now()) @map("created_at")
  updatedAt                           DateTime            @default(now()) @map("updated_at")
  deletedAt                           DateTime?           @map("deleted_at")
  isDeleted                           Boolean             @default(false) @map("is_deleted")

  // Relations
  server          servers?            @relation(fields: [serverId], references: [id], onDelete: Cascade)
  parent          channels?           @relation("ChannelParent", fields: [parentId], references: [id], onDelete: SetNull)
  children        channels[]          @relation("ChannelParent")
  messages        messages[]
  recipients      channelRecipients[]
  voiceSessions   voiceSessions[]
  invites         invites[]
  webhooks        webhooks[]
  notifications   notifications[]
  threads         messages[]          @relation("ThreadChannel")

  @@index([serverId])
  @@index([parentId])
  @@index([type])
  @@index([snowflakeId])
  @@map("channels")
}

model channelRecipients {
  channelId   BigInt    @map("channel_id")
  userId      BigInt    @map("user_id")
  joinedAt    DateTime  @default(now()) @map("joined_at")

  // Relations
  channel channels @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user    users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([channelId, userId])
  @@index([userId])
  @@map("channel_recipients")
}

// ============================================================
// MESSAGE MODELS
// ============================================================

model messages {
  id                      BigInt          @id @default(autoincrement())
  snowflakeId             BigInt          @map("snowflake_id")
  channelId               BigInt          @map("channel_id")
  authorId                BigInt?         @map("author_id")
  webhookId               BigInt?         @map("webhook_id")
  applicationId           BigInt?         @map("application_id")
  content                 String?
  timestamp               DateTime        @default(now())
  editedTimestamp         DateTime?       @map("edited_timestamp")
  editCount               Int             @default(0) @map("edit_count")
  editHistory             Json            @default("[]") @map("edit_history")
  isPinned                Boolean         @default(false) @map("is_pinned")
  tts                     Boolean         @default(false)
  mentionEveryone         Boolean         @default(false) @map("mention_everyone")
  mentions                Json            @default("[]")
  mentionRoles            Json            @default("[]") @map("mention_roles")
  mentionChannels         Json            @default("[]") @map("mention_channels")
  attachments             Json            @default("[]")
  embeds                  Json            @default("[]")
  reactions               Json            @default("[]")
  nonce                   String?         @db.VarChar(255)
  messageReference        Json?           @map("message_reference")
  referencedMessageId     BigInt?         @map("referenced_message_id")
  threadId                BigInt?         @map("thread_id")
  components              Json            @default("[]")
  stickerItems            Json            @default("[]") @map("sticker_items")
  stickers                Json            @default("[]")
  position                Int?
  roleSubscriptionData    Json?           @map("role_subscription_data")
  resolved                Json?
  flags                   Int             @default(0)
  isDeleted               Boolean         @default(false) @map("is_deleted")
  deletedAt               DateTime?       @map("deleted_at")
  deletedBy               BigInt?         @map("deleted_by")

  // Relations
  channel             channels    @relation(fields: [channelId], references: [id], onDelete: Cascade)
  author              users?      @relation(fields: [authorId], references: [id], onDelete: SetNull)
  referencedMessage   messages?   @relation("MessageReply", fields: [referencedMessageId], references: [id], onDelete: SetNull)
  replies             messages[]  @relation("MessageReply")
  thread              channels?   @relation("ThreadChannel", fields: [threadId], references: [id], onDelete: SetNull)
  reactionsList       reactions[]
  attachmentsList     attachments[]

  @@index([channelId, timestamp])
  @@index([authorId])
  @@index([snowflakeId])
  @@index([referencedMessageId])
  @@index([threadId])
  @@index([isPinned])
  @@map("messages")
}

model reactions {
  id              BigInt      @id @default(autoincrement())
  messageId       BigInt      @map("message_id")
  channelId       BigInt      @map("channel_id")
  userId          BigInt      @map("user_id")
  emojiId         BigInt?     @map("emoji_id")
  emojiName       String?     @map("emoji_name") @db.VarChar(100)
  emojiAnimated   Boolean     @default(false) @map("emoji_animated")
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  message messages @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emojiId, emojiName])
  @@index([messageId])
  @@index([userId])
  @@map("reactions")
}

model messageReads {
  channelId           BigInt    @map("channel_id")
  userId              BigInt    @map("user_id")
  lastReadMessageId   BigInt    @map("last_read_message_id")
  lastReadTimestamp   DateTime  @default(now()) @map("last_read_timestamp")
  mentionCount        Int       @default(0) @map("mention_count")

  @@id([channelId, userId])
  @@index([userId])
  @@map("message_reads")
}

// ============================================================
// VOICE MODELS
// ============================================================

model voiceSessions {
  id                      BigInt      @id @default(autoincrement())
  channelId               BigInt      @map("channel_id")
  userId                  BigInt      @map("user_id")
  sessionId               String      @map("session_id") @db.VarChar(255)
  token                   String      @db.VarChar(255)
  endpoint                String?     @db.VarChar(255)
  isDeafened              Boolean     @default(false) @map("is_deafened")
  isMuted                 Boolean     @default(false) @map("is_muted")
  isSelfDeafened          Boolean     @default(false) @map("is_self_deafened")
  isSelfMuted             Boolean     @default(false) @map("is_self_muted")
  isStreaming             Boolean     @default(false) @map("is_streaming")
  isVideoEnabled          Boolean     @default(false) @map("is_video_enabled")
  isSuppressed            Boolean     @default(false) @map("is_suppressed")
  requestToSpeakTimestamp DateTime?   @map("request_to_speak_timestamp")
  joinedAt                DateTime    @default(now()) @map("joined_at")
  lastHeartbeatAt         DateTime    @default(now()) @map("last_heartbeat_at")

  // Relations
  channel channels @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user    users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([channelId, userId])
  @@index([channelId])
  @@index([userId])
  @@map("voice_sessions")
}

model voiceStates {
  userId                  BigInt      @id @map("user_id")
  guildId                 BigInt?     @map("guild_id")
  channelId               BigInt?     @map("channel_id")
  sessionId               String?     @map("session_id") @db.VarChar(255)
  isDeafened              Boolean     @default(false) @map("is_deafened")
  isMuted                 Boolean     @default(false) @map("is_muted")
  isSelfDeafened          Boolean     @default(false) @map("is_self_deafened")
  isSelfMuted             Boolean     @default(false) @map("is_self_muted")
  isStreaming             Boolean     @default(false) @map("is_streaming")
  isVideoEnabled          Boolean     @default(false) @map("is_video_enabled")
  isSuppressed            Boolean     @default(false) @map("is_suppressed")
  requestToSpeakTimestamp DateTime?   @map("request_to_speak_timestamp")
  updatedAt               DateTime    @default(now()) @map("updated_at")

  @@index([guildId])
  @@index([channelId])
  @@map("voice_states")
}

// ============================================================
// NOTIFICATION MODELS
// ============================================================

model notifications {
  id                  BigInt      @id @default(autoincrement())
  userId              BigInt      @map("user_id")
  type                String      @db.VarChar(50)
  title               String?     @db.VarChar(255)
  body                String?
  iconUrl             String?     @map("icon_url") @db.VarChar(500)
  data                Json        @default("{}")
  isRead              Boolean     @default(false) @map("is_read")
  readAt              DateTime?   @map("read_at")
  sourceUserId        BigInt?     @map("source_user_id")
  sourceChannelId     BigInt?     @map("source_channel_id")
  sourceServerId      BigInt?     @map("source_server_id")
  sourceMessageId     BigInt?     @map("source_message_id")
  createdAt           DateTime    @default(now()) @map("created_at")

  // Relations
  user            users     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sourceChannel   channels? @relation(fields: [sourceChannelId], references: [id], onDelete: SetNull)
  sourceServer    servers?  @relation(fields: [sourceServerId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([userId, isRead])
  @@index([type])
  @@map("notifications")
}

model pushSubscriptions {
  id          BigInt      @id @default(autoincrement())
  userId      BigInt      @map("user_id")
  endpoint    String      @db.VarChar(500)
  p256dh      String      @db.VarChar(255)
  auth        String      @db.VarChar(255)
  userAgent   String?     @map("user_agent") @db.VarChar(500)
  createdAt   DateTime    @default(now()) @map("created_at")
  lastUsedAt  DateTime    @default(now()) @map("last_used_at")

  // Relations
  user users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@index([userId])
  @@map("push_subscriptions")
}

// ============================================================
// SUBSCRIPTION MODELS
// ============================================================

model subscriptions {
  id                      BigInt      @id @default(autoincrement())
  userId                  BigInt?     @map("user_id")
  serverId                BigInt?     @map("server_id")
  stripeCustomerId        String?     @map("stripe_customer_id") @db.VarChar(255)
  stripeSubscriptionId    String?     @map("stripe_subscription_id") @db.VarChar(255)
  stripePriceId           String?     @map("stripe_price_id") @db.VarChar(255)
  tier                    String      @db.VarChar(20)
  status                  String      @db.VarChar(20)
  currentPeriodStart      DateTime?   @map("current_period_start")
  currentPeriodEnd        DateTime?   @map("current_period_end")
  cancelAtPeriodEnd       Boolean     @default(false) @map("cancel_at_period_end")
  canceledAt              DateTime?   @map("canceled_at")
  endedAt                 DateTime?   @map("ended_at")
  createdAt               DateTime    @default(now()) @map("created_at")
  updatedAt               DateTime    @default(now()) @map("updated_at")
  metadata                Json        @default("{}")

  // Relations
  user    users?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  server  servers?  @relation(fields: [serverId], references: [id], onDelete: Cascade)
  boosts  serverBoosts[]

  @@index([userId])
  @@index([serverId])
  @@index([stripeSubscriptionId])
  @@map("subscriptions")
}

model serverBoosts {
  id              BigInt        @id @default(autoincrement())
  serverId        BigInt        @map("server_id")
  userId          BigInt        @map("user_id")
  subscriptionId  BigInt?       @map("subscription_id")
  boostedAt       DateTime      @default(now()) @map("boosted_at")
  expiresAt       DateTime?     @map("expires_at")

  // Relations
  server        servers       @relation(fields: [serverId], references: [id], onDelete: Cascade)
  user          users         @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription  subscriptions? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  @@unique([serverId, userId])
  @@index([serverId])
  @@index([userId])
  @@map("server_boosts")
}

// ============================================================
// FILE MODELS
// ============================================================

model attachments {
  id                      BigInt      @id @default(autoincrement())
  snowflakeId             BigInt      @unique @map("snowflake_id")
  messageId               BigInt?     @map("message_id")
  channelId               BigInt?     @map("channel_id")
  uploaderId              BigInt      @map("uploader_id")
  filename                String      @db.VarChar(255)
  contentType             String?     @map("content_type") @db.VarChar(100)
  sizeBytes               BigInt      @map("size_bytes")
  url                     String      @db.VarChar(500)
  proxyUrl                String?     @map("proxy_url") @db.VarChar(500)
  width                   Int?
  height                  Int?
  durationSecs            Float?      @map("duration_secs")
  waveform                String?
  description             String?     @db.VarChar(1024)
  isSpoiler               Boolean     @default(false) @map("is_spoiler")
  isClip                  Boolean     @default(false) @map("is_clip")
  clipParticipants        Json?       @map("clip_participants")
  clipCreatedAt           DateTime?   @map("clip_created_at")
  isThumbnailGenerated    Boolean     @default(false) @map("is_thumbnail_generated")
  thumbnailUrl            String?     @map("thumbnail_url") @db.VarChar(500)
  virusScanStatus         String      @default("pending") @map("virus_scan_status") @db.VarChar(20)
  virusScanResult         Json?       @map("virus_scan_result")
  createdAt               DateTime    @default(now()) @map("created_at")
  expiresAt               DateTime?   @map("expires_at")
  isDeleted               Boolean     @default(false) @map("is_deleted")

  // Relations
  message messages? @relation(fields: [messageId], references: [id], onDelete: SetNull)
  user    users     @relation(fields: [uploaderId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([uploaderId])
  @@index([channelId])
  @@map("attachments")
}

// ============================================================
// AUDIT & ANALYTICS MODELS
// ============================================================

model auditLogs {
  id              BigInt      @id @default(autoincrement())
  serverId        BigInt?     @map("server_id")
  actionType      Int         @map("action_type")
  userId          BigInt?     @map("user_id")
  targetId        BigInt?     @map("target_id")
  targetType      String?     @map("target_type") @db.VarChar(50)
  changes         Json        @default("[]")
  options         Json?
  reason          String?     @db.VarChar(512)
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  server  servers?  @relation(fields: [serverId], references: [id], onDelete: Cascade)
  user    users?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([serverId, createdAt])
  @@index([actionType])
  @@index([userId])
  @@map("audit_logs")
}

model analyticsEvents {
  id              BigInt      @id @default(autoincrement())
  eventType       String      @map("event_type") @db.VarChar(100)
  userId          BigInt?     @map("user_id")
  serverId        BigInt?     @map("server_id")
  channelId       BigInt?     @map("channel_id")
  sessionId       String?     @map("session_id") @db.VarChar(255)
  ipHash          String?     @map("ip_hash") @db.VarChar(64)
  userAgentHash   String?     @map("user_agent_hash") @db.VarChar(64)
  metadata        Json        @default("{}")
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  user    users?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  server  servers?  @relation(fields: [serverId], references: [id], onDelete: SetNull)
  channel channels? @relation(fields: [channelId], references: [id], onDelete: SetNull)

  @@index([eventType, createdAt])
  @@index([userId, createdAt])
  @@index([serverId, createdAt])
  @@map("analytics_events")
}

model analyticsDaily {
  date                    DateTime    @id
  dau                     Int         @default(0)
  mau                     Int         @default(0)
  newUsers                Int         @default(0) @map("new_users")
  messagesSent            BigInt      @default(0) @map("messages_sent")
  messagesDeleted         Int         @default(0) @map("messages_deleted")
  reactionsAdded          Int         @default(0) @map("reactions_added")
  voiceMinutes            Int         @default(0) @map("voice_minutes")
  filesUploaded           Int         @default(0) @map("files_uploaded")
  filesTotalSize          BigInt      @default(0) @map("files_total_size")
  serversCreated          Int         @default(0) @map("servers_created")
  serversDeleted          Int         @default(0) @map("servers_deleted")
  subscriptionsStarted    Int         @default(0) @map("subscriptions_started")
  subscriptionsCanceled   Int         @default(0) @map("subscriptions_canceled")
  revenueCents            BigInt      @default(0) @map("revenue_cents")
  retentionD1             Float?      @map("retention_d1")
  retentionD7             Float?      @map("retention_d7")
  retentionD30            Float?      @map("retention_d30")
  updatedAt               DateTime    @default(now()) @map("updated_at")

  @@map("analytics_daily")
}

// ============================================================
// INVITE & RELATIONSHIP MODELS
// ============================================================

model invites {
  code                    String      @id @db.VarChar(255)
  serverId                BigInt?     @map("server_id")
  channelId               BigInt      @map("channel_id")
  inviterId               BigInt?     @map("inviter_id")
  targetType              Int?        @map("target_type")
  targetUserId            BigInt?     @map("target_user_id")
  approximateMemberCount  Int?        @map("approximate_member_count")
  approximatePresenceCount Int?       @map("approximate_presence_count")
  expiresAt               DateTime?   @map("expires_at")
  maxUses                 Int?        @map("max_uses")
  uses                    Int         @default(0)
  temporary               Boolean     @default(false)
  uniqueUsers             Boolean     @default(false) @map("unique_users")
  createdAt               DateTime    @default(now()) @map("created_at")
  deletedAt               DateTime?   @map("deleted_at")

  // Relations
  server  servers?  @relation(fields: [serverId], references: [id], onDelete: Cascade)
  channel channels  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([serverId])
  @@index([channelId])
  @@index([inviterId])
  @@map("invites")
}

model friendships {
  id          BigInt      @id @default(autoincrement())
  userId      BigInt      @map("user_id")
  friendId    BigInt      @map("friend_id")
  status      String      @db.VarChar(20)
  requestedAt DateTime    @default(now()) @map("requested_at")
  acceptedAt  DateTime?   @map("accepted_at")
  nickname    String?     @db.VarChar(32)

  // Relations
  user    users   @relation("FriendshipUser", fields: [userId], references: [id], onDelete: Cascade)
  friend  users   @relation("FriendshipFriend", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
  @@index([userId])
  @@index([friendId])
  @@index([userId, status])
  @@map("friendships")
}

model bans {
  id          BigInt      @id @default(autoincrement())
  serverId    BigInt      @map("server_id")
  userId      BigInt      @map("user_id")
  bannedBy    BigInt      @map("banned_by")
  reason      String?     @db.VarChar(512)
  expiresAt   DateTime?   @map("expires_at")
  createdAt   DateTime    @default(now()) @map("created_at")

  // Relations
  server  servers @relation(fields: [serverId], references: [id], onDelete: Cascade)

  @@unique([serverId, userId])
  @@index([serverId])
  @@index([expiresAt])
  @@map("bans")
}

model webhooks {
  id              BigInt      @id @default(autoincrement())
  snowflakeId     BigInt      @unique @map("snowflake_id")
  serverId        BigInt?     @map("server_id")
  channelId       BigInt      @map("channel_id")
  creatorId       BigInt?     @map("creator_id")
  name            String      @db.VarChar(80)
  avatarUrl       String?     @map("avatar_url") @db.VarChar(500)
  tokenHash       String?     @map("token_hash")
  applicationId   BigInt?     @map("application_id")
  type            Int         @default(1)
  url             String?     @db.VarChar(500)
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @default(now()) @map("updated_at")

  // Relations
  server  servers?  @relation(fields: [serverId], references: [id], onDelete: Cascade)
  channel channels  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([serverId])
  @@index([channelId])
  @@map("webhooks")
}

model emojis {
  id              BigInt      @id @default(autoincrement())
  snowflakeId     BigInt      @unique @map("snowflake_id")
  serverId        BigInt      @map("server_id")
  creatorId       BigInt?     @map("creator_id")
  name            String      @db.VarChar(32)
  animated        Boolean     @default(false)
  imageUrl        String      @map("image_url") @db.VarChar(500)
  isAvailable     Boolean     @default(true) @map("is_available")
  roles           Json        @default("[]")
  requiresColons  Boolean     @default(true) @map("requires_colons")
  managed         Boolean     @default(false)
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  server  servers @relation(fields: [serverId], references: [id], onDelete: Cascade)
  user    users?  @relation("EmojiCreator", fields: [creatorId], references: [id], onDelete: SetNull)

  @@index([serverId])
  @@map("emojis")
}
